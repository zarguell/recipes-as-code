---
import { readdir } from "fs/promises";
import { resolve } from "path";
import { readFileSync } from "fs";
import { Recipe } from "@tmlmt/cooklang-parser";
import RecipeCard from "../../components/RecipeCard.astro";
import ThemeToggle from "../../components/ThemeToggle.astro";
import ViewControls from "../../components/ViewControls.astro";
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
  const recipesDir = resolve("recipes");
  const files = await readdir(recipesDir);
  const cookFiles = files.filter((f) => f.endsWith(".cook"));

  const recipes = await Promise.all(
    cookFiles.map(async (file) => {
      const content = readFileSync(resolve(recipesDir, file), "utf-8");
      let recipe;

      try {
        recipe = new Recipe(content);
      } catch (error) {
        recipe = { metadata: { title: file.replace(".cook", ""), tags: [] } };
      }

      return {
        slug: file.replace(".cook", ""),
        parsed: recipe,
      };
    })
  );

  // Get all unique tags
  const tagMap = new Map();
  recipes.forEach(recipe => {
    const tags = recipe.parsed.metadata.tags || [];
    tags.forEach(tag => {
      if (!tagMap.has(tag)) {
        tagMap.set(tag, []);
      }
      tagMap.get(tag).push(recipe);
    });
  });

  // Generate a page for each tag
  return Array.from(tagMap.entries()).map(([tag, recipes]) => ({
    params: { tag },
    props: { recipes },
  }));
}

const { tag } = Astro.params;
const { recipes } = Astro.props;
---

<Layout title={`#${tag} Recipes`} description={`Recipes tagged with ${tag}`}>
  <Fragment slot="theme-toggle">
    <ThemeToggle />
  </Fragment>

  <a href={import.meta.env.BASE_URL} class="back-link">‚Üê Back to all recipes</a>
  <h1>Recipes tagged with</h1>
  <div class="tag-badge">#{tag}</div>

  <ViewControls />

  <div class="recipe-grid view-grid">
    {recipes.map((recipe) => <RecipeCard recipe={recipe} />)}
  </div>
</Layout>

<style>
  .tag-badge {
    background: var(--surface);
    color: var(--accent-2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    display: inline-block;
    margin-bottom: 2rem;
    font-weight: bold;
    border: 2px solid var(--accent-2);
  }
</style>
