---
import { readdir } from "fs/promises";
import { resolve } from "path";
import { readFileSync } from "fs";
import { Recipe } from "@tmlmt/cooklang-parser";
import JsonLdSchema from "../../components/JsonLdSchema.astro";
import IngredientList from "../../components/IngredientList.astro";
import RecipeSteps from "../../components/RecipeSteps.astro";

export async function getStaticPaths() {
  const recipesDir = resolve("recipes");
  const files = await readdir(recipesDir);
  const cookFiles = files.filter((f) => f.endsWith(".cook"));

  return cookFiles.map((file) => ({
    params: { slug: file.replace(".cook", "") },
  }));
}

const { slug } = Astro.params;
const recipePath = resolve("recipes", `${slug}.cook`);
const content = readFileSync(recipePath, "utf-8");

let recipe;
let parseError = null;

try {
  recipe = new Recipe(content);
} catch (error) {
  console.error(`Error parsing recipe ${slug}:`, error.message);
  parseError = error.message;
  recipe = {
    metadata: { title: slug },
    ingredients: [],
    sections: [],
  };
}

const ingredients = recipe.ingredients || [];

// Extract steps from ALL sections and flatten
const steps = [];
if (recipe.sections) {
  for (const section of recipe.sections) {
    if (section.content) {
      const sectionSteps = section.content.filter((item: any) => item.type === "step");
      steps.push(...sectionSteps);
    }
  }
}

// Helper to extract text from step items
function getStepText(items: any[]) {
  if (!items || items.length === 0) return "";
  
  return items
    .map((item) => {
      if (item.type === "text") return item.value;
      if (item.type === "ingredient") return item.displayName || item.name || "";
      if (item.type === "cookware") {
        // Cookware has a name field
        return item.name || "cookware";
      }
      if (item.type === "timer") {
        // Timer has a quantity object with value
        if (item.quantity?.value?.value) {
          const time = item.quantity.value.value;
          const unit = item.unit || "minutes";
          return `${time} ${unit}`;
        }
        return "timer";
      }
      return "";
    })
    .join("");
}

const imageUrl = recipe.metadata.image?.replace(/^["']|["']$/g, '') || null;
const tags = recipe.metadata.tags || [];
const source = recipe.metadata.source;

// Default placeholder SVG
const defaultImage = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect fill='%23f5f5f5' width='400' height='300'/%3E%3Ctext fill='%23999' font-family='system-ui,sans-serif' font-size='18' x='50%25' y='50%25' text-anchor='middle' dy='.3em'%3Eüç≥ No Image%3C/text%3E%3C/svg%3E";

// Generate JSON-LD schema
const jsonLd = {
  "@context": "https://schema.org/",
  "@type": "Recipe",
  name: recipe.metadata.title || slug,
  description: recipe.metadata.description || "",
  image: imageUrl,
  prepTime: recipe.metadata["prep-time"] ? `PT${recipe.metadata["prep-time"]}` : null,
  cookTime: recipe.metadata["cook-time"] ? `PT${recipe.metadata["cook-time"]}` : null,
  totalTime: recipe.metadata["total-time"] ? `PT${recipe.metadata["total-time"]}` : null,
  recipeYield: recipe.metadata.servings || null,
  recipeCategory: recipe.metadata.category || null,
  recipeCuisine: recipe.metadata.cuisine || null,
  keywords: tags.join(", "),
  author: {
    "@type": "Person",
    name: recipe.metadata.author || "Unknown",
  },
  recipeIngredient: ingredients.map((ing) => {
    let str = ing.name || "";
    if (ing.quantity?.value?.value !== undefined) {
      const qty = ing.quantity.value.value;
      str += ` ${qty}`;
      if (ing.unit) str += ` ${ing.unit}`;
    }
    return str;
  }),
  recipeInstructions: steps.map((step: any, idx: number) => ({
    "@type": "HowToStep",
    position: idx + 1,
    text: getStepText(step.items || []),
  })),
};
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-case=1" />
    <title>{recipe.metadata.title || slug}</title>
    <JsonLdSchema schema={jsonLd} />
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
        background: #faf9f7;
        line-height: 1.6;
      }
      .recipe-header {
        margin-bottom: 2rem;
      }
      h1 {
        color: #2d3436;
        margin: 0 0 0.5rem;
      }
      .recipe-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1rem 0;
      }
      .recipe-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
      }
      .meta-item {
        background: white;
        padding: 1rem;
        border-radius: 6px;
        border-left: 3px solid #ff6b6b;
      }
      .meta-label {
        font-size: 0.85rem;
        color: #636e72;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
      }
      .meta-value {
        font-weight: bold;
        color: #2d3436;
      }
      .recipe-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin: 2rem 0;
      }
      @media (max-width: 768px) {
        .recipe-content {
          grid-template-columns: 1fr;
        }
      }
      .recipe-section h2 {
        color: #2d3436;
        border-bottom: 2px solid #ff6b6b;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }
      a {
        color: #0984e3;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
      }
      .tag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.25rem 0.75rem;
        border-radius: 16px;
        font-size: 0.85rem;
        text-decoration: none;
      }
      .tag:hover {
        background: #bbdefb;
      }
      .source {
        background: #fff3e0;
        border-left: 3px solid #ff9800;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
      }
      .source-label {
        font-size: 0.85rem;
        color: #e65100;
        font-weight: bold;
        margin-bottom: 0.25rem;
      }
    </style>
  </head>
  <body>
    <div class="recipe-header">
      <a href={import.meta.env.BASE_URL}>‚Üê Back to recipes</a>
      <h1>{recipe.metadata.title || slug}</h1>
      {recipe.metadata.description && <p>{recipe.metadata.description}</p>}
      
      {tags.length > 0 && (
        <div class="tags">
          {tags.map((tag: string) => (
            <a href={`${import.meta.env.BASE_URL}tags/${tag}/`} class="tag">
              #{tag}
            </a>
          ))}
        </div>
      )}
      
      {source && (
        <div class="source">
          <div class="source-label">Source:</div>
          <a href={source} target="_blank" rel="noopener noreferrer">{source}</a>
        </div>
      )}
      
      <img
        src={imageUrl || defaultImage}
        alt={recipe.metadata.title || slug}
        class="recipe-image"
        onerror={`this.onerror=null;this.src="${defaultImage.replace(/'/g, '%27')}";`}
        loading="lazy"
      />
    </div>

    <div class="recipe-meta">
      {recipe.metadata?.servings && (
        <div class="meta-item">
          <div class="meta-label">Servings</div>
          <div class="meta-value">{recipe.metadata.servings}</div>
        </div>
      )}
      {recipe.metadata?.["prep-time"] && (
        <div class="meta-item">
          <div class="meta-label">Prep Time</div>
          <div class="meta-value">{recipe.metadata["prep-time"]}</div>
        </div>
      )}
      {recipe.metadata?.["cook-time"] && (
        <div class="meta-item">
          <div class="meta-label">Cook Time</div>
          <div class="meta-value">{recipe.metadata["cook-time"]}</div>
        </div>
      )}
      {recipe.metadata?.["total-time"] && (
        <div class="meta-item">
          <div class="meta-label">Total Time</div>
          <div class="meta-value">{recipe.metadata["total-time"]}</div>
        </div>
      )}
    </div>

    <div class="recipe-content">
      <div class="recipe-section">
        <h2>ü•ò Ingredients</h2>
        <IngredientList ingredients={ingredients} />
      </div>
      <div class="recipe-section">
        <h2>üë®‚Äçüç≥ Instructions</h2>
        {steps.length > 0 ? (
          <RecipeSteps steps={steps} />
        ) : (
          <p>No instructions found</p>
        )}
      </div>
    </div>
  </body>
</html>
