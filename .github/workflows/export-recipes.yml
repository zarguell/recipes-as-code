name: Export Recipes

on:
  push:
    paths:
      - 'recipes/**/*.cook'
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install CookCLI
        env:
          # renovate: datasource=github-releases depName=cooklang/cookcli
          COOKCLI_VERSION: 0.19.0
        run: |
          wget -q "https://github.com/cooklang/cookcli/releases/download/v${COOKCLI_VERSION}/cook-x86_64-unknown-linux-gnu.tar.gz" -O cook.tar.gz
          tar -xzf cook.tar.gz
          sudo mv cook /usr/local/bin/
          chmod +x /usr/local/bin/cook
          cook --version

      
      - name: Create output directories
        run: |
          mkdir -p generated/schema-org
          mkdir -p generated/markdown
          mkdir -p generated/json
      
      - name: Export recipes to all formats
        run: |
          for recipe in recipes/*.cook; do
            if [ -f "$recipe" ]; then
              filename=$(basename "$recipe" .cook)
              echo "üìù Exporting $filename..."
              
              # Try schema format first, fallback to json if not available
              if cook recipe "$recipe" -f schema --help 2>&1 | grep -q "schema"; then
                cook recipe "$recipe" -f schema -o "generated/schema-org/${filename}.json"
              else
                echo "  ‚ö†Ô∏è  Schema format not available, using JSON"
                cook recipe "$recipe" -f json -o "generated/schema-org/${filename}.json"
              fi
              
              # Markdown (for browsing/static site)
              cook recipe "$recipe" -f markdown -o "generated/markdown/${filename}.md"
              
              # JSON (for programmatic access)
              cook recipe "$recipe" -f json -o "generated/json/${filename}.json"
            fi
          done

      - name: Generate index files
        run: |
          recipe_count=$(ls recipes/*.cook 2>/dev/null | wc -l)
          
          # Markdown index
          echo "# Recipe Collection" > generated/markdown/INDEX.md
          echo "" >> generated/markdown/INDEX.md
          echo "üìö Total recipes: **${recipe_count}**" >> generated/markdown/INDEX.md
          echo "" >> generated/markdown/INDEX.md
          echo "## All Recipes" >> generated/markdown/INDEX.md
          echo "" >> generated/markdown/INDEX.md
          
          for recipe in recipes/*.cook; do
            if [ -f "$recipe" ]; then
              filename=$(basename "$recipe" .cook)
              title=$(head -n1 "$recipe" | sed 's/>>//g' | xargs)
              echo "- [$title](./${filename}.md)" >> generated/markdown/INDEX.md
            fi
          done
          
          echo "‚úÖ Generated index files"

      - name: Commit generated files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add generated/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü§ñ Auto-export recipes [skip ci]"
            git push
          fi
      
      # - name: Trigger Tandoor import
      #   if: github.ref == 'refs/heads/main' && secrets.N8N_WEBHOOK_URL != ''
      #   env:
      #     N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
      #   run: |
      #     echo "üç≥ Triggering Tandoor import..."
      #     for json_file in generated/schema-org/*.json; do
      #       filename=$(basename "$json_file")
      #       echo "Importing: $filename"
      #       curl -X POST "$N8N_WEBHOOK_URL" \
      #         -H "Content-Type: application/json" \
      #         -d @"$json_file" \
      #         -s -o /dev/null -w "  Status: %{http_code}\n"
      #     done
